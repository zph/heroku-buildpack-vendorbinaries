#!/bin/bash

set -eou pipefail

indent() {
  sed -u 's/^/       /'
}

curl_into_tar(){
  local url="$1"
  local flags="$2"
  curl -L --silent "$url" | tar $flags -
}

determine_filetype_and_download(){
  set -x
  local url="$1"
  filename="$(echo "$url" | awk -F "/" '{print $NF}')"
  case "$filename" in
    *.tar.gz) curl_into_tar "$url" "-xzf" ;;
    *.gz) curl_into_tar "$url" "-xzf" ;;
    *.xz) curl_into_tar "$url" "x --xz" ;;
    *.bz2) curl_into_tar "$url" "x --bzip2" ;;
    *.tar) curl_into_tar "$url" "" ;;
    *) wget "$url"
  esac
  set +x
}

main(){
  echo "-----> Found a .vendor_urls file"

  # Bail early but noisily
  if [ ! -s "$1/.vendor_urls" ]; then
    echo ".vendor_urls empty. Skipping." | indent
    exit 0
  fi

  cd "$1" || exit 1

  while read -r url; do
    if [ -n "$url" ]; then # incase ensure_newline_at_eof_on_save is enabled
      echo "Vendoring $url" | indent

      determine_filetype_and_download "$url"
    fi
  done < .vendor_urls
}

main "$@"
